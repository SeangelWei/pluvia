package model;

import utils.GameObject;

import java.util.ArrayList;
import java.util.List;

public class World extends GameObject {
    Player player;
    List<Ball> balls = new ArrayList<Ball>();
    List<Cloud> clouds = new ArrayList<Cloud>();
    int points;

    public World(float x, float y) {
        super(x, y);
    }

    public void init(){
        player = null;
        player = new Player(250, 100);
        clouds.clear();
        clouds.add(new Cloud(90, -30));
        clouds.add(new Cloud(250, -32));
        clouds.add(new Cloud(430, -35));

        balls.add(new Ball(50, 300, Ball.sizeDef.BIG, 6f));
    }

    @Override
    public void update() {
        for (Ball ball : balls) {
            ball.update();
        }
        for (Cloud cloud : clouds) {
            cloud.update();
        }
        player.update();
        updateLogic();
    }

    private void updateLogic() {
        for (int i = 0; i < balls.size();i++) {
            Ball ball = balls.get(i);
            if (checkCollision(player.position.x, player.position.y, player.bounds.getWidth(), player.bounds.getHeight(), ball)) {
                createNewBall(ball);
                balls.remove(i);
                player.setLives(player.getLives() - 1);
            }
        }

        if(player.isShooting()){
            for(int i = 0; i < balls.size();i++){
                Ball ball = balls.get(i);
                if(player.getShot() != null){
                    if(checkCollision(player.getShot().position.x, player.getShot().position.y,
                            player.getShot().bounds.getWidth(), player.getShot().bounds.getHeight(), ball)){
                        player.setShot(null);
                        player.setShooting(false);
                        createNewBall(balls.get(i));
                        balls.remove(i);
                    }
                }
            }
        }
    }

    private boolean checkCollision(float x, float y, float width, float height, Ball ball){
        float circleDistanceX = abs(ball.position.x+ball.getRadius() - x - width/2);
        float circleDistanceY = abs(ball.position.y+ball.getRadius() - y - height/2);

        if (circleDistanceX > (width/2 + ball.getRadius())) { return false; }
        if (circleDistanceY > (height/2 + ball.getRadius())) { return false; }

        if (circleDistanceX <= (width/2)) { return true; }
        if (circleDistanceY <= (height/2)) { return true; }

        float cornerDistance_sq = pow(circleDistanceX - width/2, 2) +
                pow(circleDistanceY - height/2, 2);

        return (cornerDistance_sq <= pow(ball.getRadius(),2));
    }

    private float pow(float n, float e) {
        return (float) Math.pow(n, e);
    }

    private float abs(float number) {
        return Math.abs(number);
    }

    private void createNewBall(Ball toDestroyBall){
        switch(toDestroyBall.getSize()){
            case BIG:
                Ball middleBall1 = new Ball(toDestroyBall.position.x+toDestroyBall.getRadius(), toDestroyBall.position.y+toDestroyBall.getRadius(), Ball.sizeDef.MIDDLE, -2.4f);
                Ball middleBall2 = new Ball(toDestroyBall.position.x+toDestroyBall.getRadius(), toDestroyBall.position.y+toDestroyBall.getRadius(), Ball.sizeDef.MIDDLE, 2.2f);
                middleBall1.setyVector(25);
                middleBall2.setyVector(25);
                balls.add(middleBall1);
                balls.add(middleBall2);
                points+=50;
                break;
            case MIDDLE:
                Ball smallBall1 = new Ball(toDestroyBall.position.x+toDestroyBall.getRadius(), toDestroyBall.position.y+toDestroyBall.getRadius(), Ball.sizeDef.SMALL, -2.4f);
                Ball smallBall2 = new Ball(toDestroyBall.position.x+toDestroyBall.getRadius(), toDestroyBall.position.y+toDestroyBall.getRadius(), Ball.sizeDef.SMALL, 2.2f);
                smallBall1.setyVector(25);
                smallBall2.setyVector(25);
                balls.add(smallBall1);
                balls.add(smallBall2);
                points+=30;
                break;
            case SMALL:
                points+=20;
                break;
            default:
                break;
        }
    }
    public Player getPlayer() {
        return player;
    }
    public List<Ball> getBalls(){
        return balls;
    }
}
